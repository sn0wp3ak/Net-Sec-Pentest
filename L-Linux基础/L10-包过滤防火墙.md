**iptables工具**

4表5链

4个功能(表)

raw

mangle

nat

filter  过滤

查看filter表

```
iptables -t filter -nvL   
```

每张表都有一个专门写规则的地方   chain(链)   

filter中的链

INPUT    源IP  目标IP   协议tcp   端口号80 

FORWARD   转发规则链 (当原地址以及目标地址都不是本机地址)

OUTPUT   出站链

```
watch -n1 iptables -t filter -nvL
```

目标主机不可达  --  出站链

```
# 给filter表的INPUT链的最上面(Insert)添加一条策略
iptables -t filter -I INPUT -p tcp --dport 80 -j ACCEPT
```

**iptables基本语法**

```
iptables [-t 表名] 选项 [链名][条件][-j 控制类型]
```

注意事项:

* 不指定表名时, 默认是filter表
* 不指定链名时, 默认是所有链
* 除非设置链的默认值, 否则必须指定匹配条件
* 选项, 链名, 控制类型使用大写字母, 其他均使用小写

**数据包的常见控制类型**

```
ACCEPT 允许通过
DROP   直接丢弃, 不给任何回应
REJECT 拒绝通过, 必要时给出提示
LOG    记录日志信息, 然后传给下一条规则继续匹配
```

条件相同的规则, 上面的生效

添加新的规则的选项

* `-A`: 在链的末尾追加
* `-I`: 在链的开头插入

查看规则表

* `-L`: 列出所有的规则条目
* `-n`: 以数字形式显示地址, 端口等信息
* `-v`: 以更详细的方式显示规则信息
* `--line-numbers`: 查看规则的同时, 显示规则的序号

删除, 清空规则

* `-D`: 删除链内指定序号(或内容)的一条规则
* `-F`: 清空所有的规则

设置默认策略

* `-P`: 为指定的链设置默认规则
  * 只能选DROP或ACCEPT

**规则的匹配条件**

* 通用匹配
  * 可以直接使用, 不依赖于其他条件或者扩展
  * 包括网络协议, IP地址, 网络接口等条件
* 隐含匹配
  * 要求以特定的协议匹配作为前提
  * 包括端口号, TCP标记, ICMP类型等条件
* 显式匹配
  * 要求以"-m 扩展模块"的形式明确地指出类型
  * 包括多端口, MAC地址, IP范围, 数据包状态等条件

常见的通用匹配条件

> 协议匹配:  `-p` 协议名
>
> 地址匹配: `-s`  源IP地址, `-d`  目标IP地址
>
> 接口匹配: `-i`  入站网卡, `-o`  出站网卡

常用的隐含匹配条件

> 端口匹配: `--sport 源端口`, `--dport 目标端口`
>
> TCP标记匹配: `--tcp-flags 检查范围 被设置的标记`
>
> ICMP类型匹配: `--icmp-type ICMP类型(8请求, 0回显, 3不可达)               `  

常用的显式匹配条件

> 多端口匹配: `-m multiport --sport 源端口列表`
>
> ​                     `-m multiport --dport 目标端口列表`
>
> IP范围匹配:  `-m iprange --src-range IP范围`
>
> MAC地址匹配: `-m mac --mac-source MAC地址`
>
> 状态匹配: `-m state --state 连接状态`

**导出 (备份) 规则**

> iptables-save 工具
>
> 可结合重定向输出保存到指定文件

```
iptables-save > iptables_all.txt
```

保存成默认规则

```
service iptables save
```

**导入规则**

> iptables-restore 工具
>
> 可结合输入重定向从文件中导入

```
iptables-restore < iptables_all.txt
```



**nat表**

查看nat表

```
iptables -t ant -nvL
```

链

PREROUTING

POSTROUTING   路由后

OUTPUT

源地址转换SNAT

 ```
iptables -t nat -A POSTROUTING -p tcp -o eth1 -s 192.168.1.0/24 -j SNAT --to-source 12.34.56.78
 ```

```
iptables -t nat -A POSTROUTING -p tcp -o eth1 -s 192.168.1.0/24 -j MASQUERADE
```

目标地址转换DNAT

